# -*- coding: utf8 -*-
import json
import re
from ulti import remove_accents
import numpy as np
from fuzzywuzzy import fuzz
from fuzzywuzzy import process


with open('sample.json') as f:
    sample = json.load(f)

numeric_const_pattern = ' (?: (?: \d* \. \d+ ) | (?: \d+ \.? ) )(?: [Ee] \d+ ) ?'
rx = re.compile(numeric_const_pattern, re.VERBOSE)


"""deal with dt cong nhan"""
def deal_with_dt_congnhan(sample, key_dt_congnhan):
  area_cal = 0
  calculation = 1
  info_of_areacal = []
  hecta = ["ha", "hecta"]
  in_hecta = False

  for item in range(len(sample["attributes"]) - 1):

    if sample["attributes"][item]["type"]=="area" and sample["attributes"][item-1]["type"] == "normal":

      format_areacontent = re.sub(r'\s+', '', sample["attributes"][item]["content"])
      format_areacontent = format_areacontent.replace(',','.')

      format_normalcontent = re.sub(r'\s+', '', sample["attributes"][item-1]["content"])

      areacontent = remove_accents(format_areacontent)
      normalcontent = remove_accents(format_normalcontent)

      if hecta[0] in areacontent or hecta[1] in areacontent:
        in_hecta = True

      highest_ratio = process.extractOne(normalcontent,key_dt_congnhan)

      if highest_ratio[1] >= 80:
        info_of_areacal = rx.findall(areacontent)
        info_of_areacal = [float(i) for i in info_of_areacal]
  
      
  if len(info_of_areacal) == 1:
    area_cal = info_of_areacal[0]
  elif len(info_of_areacal) == 2:
    if info_of_areacal[0] > 2 and info_of_areacal[1] > 2:
      area_cal = info_of_areacal[0]*info_of_areacal[1]
    elif info_of_areacal[0] > 2 and info_of_areacal[1] == 2:
      area_cal = info_of_areacal[0]
    elif info_of_areacal[0] == 2 and info_of_areacal[1] > 2:
      area_cal = info_of_areacal[1]
  elif len(info_of_areacal) > 2:
    for i in range(2):
      if i == 2:
        break
      else:
        calculation *= info_of_areacal[i]
  
  if in_hecta == True:
    area_cal *= 10000

  if area_cal != 0:
    return area_cal
  else:
    return 0



"""deal with dt dat"""
def deal_with_dt_dat(sample, key_dt_dat):
  area_cal = 0
  calculation = 1
  info_of_areacal = []
  hecta = ["ha", "hecta"]
  in_hecta = False
  
  for item in range(len(sample["attributes"]) - 1):

    if sample["attributes"][item]["type"]=="area":

      format_areacontent = re.sub(r'\s+', '', sample["attributes"][item]["content"])
      format_areacontent = format_areacontent.replace(',','.')

      format_prevcontent = re.sub(r'\s+', '', sample["attributes"][item-1]["content"])

      areacontent = remove_accents(format_areacontent)
      prevcontent = remove_accents(format_prevcontent)

      if hecta[0] in areacontent or hecta[1] in areacontent:
        in_hecta = True

      highest_ratio = process.extractOne(prevcontent,key_dt_dat)
      ratio_of_m2 = fuzz.partial_ratio(areacontent,"m2")
      ratio_of_ha = fuzz.partial_ratio(areacontent,"ha")

      if highest_ratio[1] >= 60 or ratio_of_m2 >= 50 or ratio_of_ha >= 80:
        info_of_areacal = rx.findall(areacontent)
        info_of_areacal = [float(i) for i in info_of_areacal]
        break
      

  if len(info_of_areacal) == 1:
    area_cal = info_of_areacal[0]
  elif len(info_of_areacal) == 2:
    if info_of_areacal[0] > 2 and info_of_areacal[1] > 2:
      area_cal = info_of_areacal[0]*info_of_areacal[1]
    elif info_of_areacal[0] > 2 and info_of_areacal[1] == 2:
      area_cal = info_of_areacal[0]
    elif info_of_areacal[0] == 2 and info_of_areacal[1] > 2:
      area_cal = info_of_areacal[1]
  elif len(info_of_areacal) > 2:
    for i in range(2):
      if i == 2:
        break
      else:
        calculation *= info_of_areacal[i]
    area_cal = calculation

  if in_hecta == True:
    area_cal *= 10000

  if area_cal != 0:
    return area_cal
  else:
    return 0

"""deal with dt xaydung/san"""
def deal_with_dt_xaydung_san(sample, key_dt_xaydung_san):
  area_cal = 0
  calculation = 1
  info_of_areacal = [] 
  in_hecta = False

  for item in range(len(sample["attributes"]) - 1):

    if sample["attributes"][item]["type"] == "area":

      format_areacontent = re.sub(r'\s+', '', sample["attributes"][item]["content"])
      format_areacontent = format_areacontent.replace(',','.')
      
      format_prevcontent = re.sub(r'\s+', '', sample["attributes"][item-1]["content"])

      areacontent = remove_accents(format_areacontent)
      prevcontent = remove_accents(format_prevcontent)

      highest_ratio = process.extractOne(prevcontent,key_dt_xaydung_san)

      if highest_ratio[1] >= 80:
        info_of_areacal = rx.findall(areacontent)
        info_of_areacal = [float(i) for i in info_of_areacal]
        break
  
  if len(info_of_areacal) == 1:
    area_cal = info_of_areacal[0]
  elif len(info_of_areacal) == 2:
    if info_of_areacal[0] > 2 and info_of_areacal[1] > 2:
      area_cal = info_of_areacal[0]*info_of_areacal[1]
    elif info_of_areacal[0] > 2 and info_of_areacal[1] == 2:
      area_cal = info_of_areacal[0]
    elif info_of_areacal[0] == 2 and info_of_areacal[1] > 2:
      area_cal = info_of_areacal[2]
  elif len(info_of_areacal) > 2:
    for i in range(2):
      if i == 2:
        break
      else:
        calculation *= info_of_areacal[i]
    area_cal = calculation

  if in_hecta == True:
    area_cal *= 10000

  if area_cal != 0:
    if sample["floor"] != 0: 
      return area_cal/sample["floor"]
    else:
      return area_Cal
  else:
    return 0




    


def xacdinh(dict_input: dict) -> float:
  """Phân biệt diện tích đất
  Arguments:
      inp_str {dict} -- dict chứa 3 thông tin sau:
          id              : id của bài đăng
          content         : content của bài đăng
          realestate_type : loại bất động sản
          floor           : số tầng
  Returns:
      float - gía trị của biến area_cal
  Như trong doc thì có 3 loại diện tích:
  """

  """dt_congnhan > dt_dat > dt_xaydung_san"""
  key_dt_congnhan = ["dientichcongnhan","cn","dtcn","congnhan"]
  key_dt_dat = ["dientichdat","dat"]
  key_dt_xaydung_san = ["dientichxaydung","dientichsan","san","xaydung","dt"]

  dt_congnhan = 0.0
  dt_dat = 0.0
  dt_xaydung_san = 0.0

  area_cal = 0.0

  ## code goes here
  dt_congnhan = deal_with_dt_congnhan(sample, key_dt_congnhan)
  dt_dat = deal_with_dt_dat(sample, key_dt_dat)

  print("dt_congnhan: ", dt_congnhan)
  print("dt_dat: ",dt_dat)
  if dt_congnhan != 0:
    area_cal = dt_congnhan
  elif dt_dat != 0: 
    area_cal = dt_dat
  else:
    dt_xaydung_san = deal_with_dt_xaydung_san(sample, key_dt_xaydung_san)
    area_cal = dt_xaydung_san
    print("dt_xaydung_san: ", dt_xaydung_san)

  print(area_cal)
  ############################
  ## Return
  ############################
  return area_cal


xacdinh(sample)